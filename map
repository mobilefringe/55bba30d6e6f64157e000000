<!-- Map Dependency -->
<script src="//mallmaverick.cdn.speedyrails.net/javascripts/mapsvg/jquery.js"></script>
<script src="//mallmaverick.cdn.speedyrails.net/javascripts/mapsvg/raphael.js"></script>
<script src="//mallmaverick.cdn.speedyrails.net/javascripts/mapsvg/jquery.mousewheel.js"></script>
<script src="//mallmaverick.cdn.speedyrails.net/system/site_images/photos/000/005/107/original/mallmaverick_svgmap.js?1412885524"></script>

<style>
    /*.map_container{*/
    /*    height:490px;*/
    /*}*/
    .popup {
        background: none repeat scroll 0 0 #000000;
        border: 1px solid #808080;
        border-radius: 6px;
        box-shadow: -1px 1px 4px 1px #000;
        color: #ffffff;
        font-size: 18px;
        font-weight: bold;
        padding-bottom: 8px;
        padding-top: 8px;
        text-align: center;
        width: 200px;
        margin-top: 30px;
    }
    .store_initial {
        color: #fff;
        background: black;
        margin-bottom: 10px;
        padding: 10px 12px;
        font-weight: bold;
        opacity: 0.8;
        width:100%;
    }
    .store_name_map {
        color: #000000;
        font-size: 18px;
        font-weight: 400;
        padding: 5px 12px;
        width: 250px;
        display: block;
    }
    .position_relative .dropdown-menu{
        width:300px;
        padding-top:0;
        margin-top:2px;
    }
    /*.map_tooltip img{*/
    /*    max-width:200px;*/
    /*}*/
</style>
<div class="green_bar"></div>
<div class="page_main_container">
    <div class="page_left">
        <h3 class="hours_heading promo_heading">Centre Map</h3>
        <div class="position_relative">        
            <div class="controls">
            	<div class="dropdown custom_dropdown">                          
                    <a class="btn-prime"  id="map_button">
                        Select a Store <span style="margin-top:3px;" class="fa fa-caret-down pull-right"></span>
                    </a>		    
                </div>            
            </div> 
            <div class="dropdown-menu bottom" id="store_table" style="top:50px">          		
                <div style="height:500px;overflow-y:scroll;overflow-x:hidden;">                                        
                    <div class="map_table">            			                        
                        <div  id="store_list_container">
                            <script id="store_list_template" type="x-tmpl-mustache/text">
                                <p class="store_initial" style="{{show}}">{{initial}}</p>
                                <a href="#" class="store_name_map" store_id="{{svgmap_region}}" onclick="return dropPin(this)">{{name}}</a>
                            </script>
                        </div>
                    </div>          
                </div>                
            </div> 
            <div class="map">
          <!--      <div class="map_container" style="">            -->
          <!--          <img style="max-width:100%;max-height:100%" alt="map_image" id="map_image" src="//midtown2.mallmaverick.com/system/properties/maps/000/000/025/original/map_midtown_edited.jpg?1381443167" />   -->
                    	
        		<!--</div>-->
        		<div id="mapplic"></div>
                <!--<div id="mapsvg_main"></div>-->
            </div>
        </div>
    </div>
    <div class="page_right">
        <div class="hours_box feature_box" id="home_hours_container">
            <script id="home_hours_template" type="x-tmpl-mustache/text">
                <h3 class="hours_header">HOURS</h3>
                <p class="check_hours"><a href="/hours">Check Holiday Hours</a></p>
                <h3 class="newsletter_header caps">{{day}} {{month}} {{weekday}}</h3>
                <h3 class="hours_home">{{h}}</h3>
                <p class="call_mp_home"><a href="tel:3066538844">Call 306-653-8844</a></p>
            </script>
        </div>
        <div class="giftcards_box feature_box">
            <a href="/pages/midtown2-gift-cards">
                <h3 class="giftcards_header">GIFT CARDS</h3>
                <img style=" max-width: 100%; max-height: 100%; " src="//codecloud.cdn.speedyrails.net/sites/55bba30d6e6f64157e000000/f80b2b0cc97fadff100319399f8b2e1e/midtown_gc_360_360.png" class="" alt="giftcards">
            </a>
        </div>
        
        <div class="newsletter_box feature_box">
            <div id="success_subscribe">
                <i class="fa fa-close pull-right cursor_pointer" id="close_subscribe"></i>
                <p class="middle_align text-center">Thank you for subscribing to our newsletter!</p>
            </div>
            <h3 class="newsletter_header">NEWSLETTER</h3>
            <p>Exclusive deals straight to your inbox!</p>
            <form action="//mobilefringe.createsend.com/t/d/s/yhudtt/" id="newsletter_form">
                <input name="cm-yhudtt-yhudtt" type="text" placeholder="Enter your email address" id="newsletter_email" class="pull-left" required/>
                <input type="submit" value="SUBSCRIBE" class="btn_mp pull-left" />
                <div class="clearfix"></div>
                <label class="check_text"><input type="checkbox" required id="newsletter_agree" />I agree to receive newsletters from Midtown.</label>
            </form>
        </div>
        <div class="feature_box border_1">
            <h3 class="feature_header">Blog</h3>
            <div class="feature_insider" id="home_blog_container">
                <script id="home_blog_template" type="x-tmpl-mustache/text">
                    <div class="feature_insider_right">
                        <h3 class="feature_2_header">{{published_on}}</h3>
                        <p class="feature_2_dates">{{title}}</p>
                        <p class="feature_2_description">{{description_shorter}}</p>
                        <a class="read_more" href="/posts/{{slug}}">read more</a>
                    </div>
                    <div class="feature_insider_left pull-right">
                        <img alt="blog" class="feature_image" src="{{post_image}}" />
                    </div>
                    <div class="clearfix"></div>
                </script>
            </div>
        </div>
    </div>
    <div class="clearfix"></div>
</div>
<style>
    .mapplic-map {
        width: 100%!important;
        height: 100%!important;
    }
    .mapplic-pin{
        /*background-color: transparent!important;    */
    }
    /* INTERACTIVE ELEMENTS */
    /* clickable elements */
    .mapplic-clickable:not(g),
    g.mapplic-clickable > * {
    	opacity: 1!important;
    	/*fill: #b7a6bd*/;
    }
    /* hovered elements */
    .mapplic-clickable:not(g):hover,
    g.mapplic-clickable:hover > * {
    	opacity: 1;
    	fill: #c2cfdf;
    }
    
    /* active elements */
    .mapplic-active,
    a.mapplic-active > path,
    g.mapplic-active > * {
    	fill: #c2cfdf;
    	opacity: 1.0 !important;
    }
    .mapplic-coordinates {
        visibility: hidden;
    }
    .mapplic-container {
        background: #fff;
        height: 100%!important;
    }
    .mapplic-zoom-buttons{
        bottom: initial!important;
        top: 0!important;
        left: initial!important;
        right: 0!important;
    }
    .mapplic-popup-link {
        float: left!important;
    }
    .mapplic-tooltip-content {
        overflow: hidden;
        overflow-y: hidden !important;
    }
    .mapplic-hovertip {
        opacity:1!important;
    }
    #nopointer-unitnumbers {
        display:none!important;
    }
</style>

<link href="//codecloud.cdn.speedyrails.net/sites/5b8018fd6e6f643f872a0000/text/css/1522163605908/mapplic.css" rel="stylesheet">
<link href="//codecloud.cdn.speedyrails.net/sites/59bac7db6e6f644f22ba0000/text/css/1485967426000/map.css" rel="stylesheet">
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.13/jquery.mousewheel.min.js"></script>
<script src="//codecloud.cdn.speedyrails.net/sites/5b8018fd6e6f643f872a0000/text/javascript/1520366143656/mapplic_mmsdk.js"></script>
<script src="//codecloud.cdn.speedyrails.net/sites/59bac7db6e6f644f22ba0000/text/javascript/1484859750000/hammer.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
<script>
    $(document).ready(function(e){
        init(e);
        function renderAll(){
            var stores = getStoresList();
            
            renderStoreList('#store_list_container','#store_list_template', stores, "stores");
            var mall_json = {};
            var landmarks = {};
            mall_json.mapwidth = "1000";
            mall_json.mapheight = "1000";
            mall_json.categories = [];
            mall_json.levels = [];
            
            // need to add the following for each floor we want to configure.
            _.forEach(floorList(), function(value, key) { 
                var floor_1 = {};
                floor_1.id = value.id;
                floor_1.title = value.title;
                floor_1.map = value.map;
                
                floor_1.show = value.show;
                floor_1.locations = [];
                var stores_on_floors =  stores; // ['z_coordinate', value.z_index]);
                _.forEach(stores_on_floors, function(val, key) {
                    //for testing limiting the store numbers to vm
                    var temp_val = {};
                    temp_val.id = val.svgmap_region;
                    temp_val.title = val.name;
                    temp_val.about = val.description.substring(0,200);
                    if(val.categories != null) {
                        if(val.categories.length>1){
                        temp_val.category = val.categories[1];
                        }
                        else {
                            temp_val.category = val.categories[0];
                        }
                    }
                    temp_val.link = "/stores/" + val.slug;
                    temp_val.pin = "hidden";
                   
                    
                    //get svg's wifth/height by checking the map
                    var svg_width = 2500;
                    var svg_height = 2500;

                    temp_val.x = val.x_coordinate / svg_width;
                    temp_val.y = val.y_coordinate / svg_height;
                    floor_1.locations.push(temp_val);
                });
                mall_json.levels.push(floor_1);
            });
            
            map = $('#mapplic').mapplic({
            	source: mall_json,
            	height: 490,
            	landmark : true,
            	mapfill:true,
            	minimap: false,
            	sidebar: false,
            	hovertip: true,
            	developer: false,
            	fullscreen : false,
            	clearbutton: false,
            	deeplinking: false,
            	fillcolor : "none",
            	maxscale: 5,
            	skin: 'mapplic-dark',
            	tooltiplabel : 'Info'
            });
            
            map.on('mapready', function(e, self) {
				console.log('Map is ready!');
				mapLoaded(map);
			});
            
        }
        function floorList () {
            var floor_list = [];
            
            var floor_1 = {};
            floor_1.id = "first-floor";
            floor_1.title = "Level One";
            // console.log(getSVGMapURL().split("?")[0])
            floor_1.map =  getSVGMapURL().split("?")[0];//"https://www.mallmaverick.com/system/site_images/photos/000/039/355/original/St.Vital_-_Leasing_Map_-_May-09-2018.svg"; 
            floor_1.z_index = null;
            floor_1.show = true;
            floor_list.push(floor_1);
            return floor_list;
        }
        function svgList () {
            return _.map(getStoresList(), 'svgmap_region');
        }
        function mapLoaded (map){
            self = map.data('mapplic');
            var svg = document.getElementById('landmarks-1');
            console.log("svg", svg);
            
            //get floors to be visible 
            $(".mapplic-layer").show();
            //go through all the regions and recalculat the locations
            _.forEach(svgList(), function(val, key) {
                
                if(val !== null) {
                    
                    var element = document.getElementById(val);
                    if (element){
                        console.log(val, element);
                        elBBox = element.getBoundingClientRect();
                        console.log(elBBox);
                        
                        var viewport_center_x = 0;
                        var viewport_center_y = 0;
                        viewport_center_x = (_.toNumber(elBBox.left) + _.toNumber(elBBox.right) )/2;
                        viewport_center_y = (_.toNumber(elBBox.top) + _.toNumber(elBBox.bottom) )/2;
                        pt = svg.createSVGPoint();
                        pt.x = viewport_center_x;
                        pt.y = viewport_center_y;
                        var svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
                        var new_x = svgP.x/ 2500;
                        var new_y = svgP.y/ 2500;
                        var location = self.getLocationData(val);
                        if(location !== null && location.el){
                            location.x = new_x;
                            location.y =  new_y;
                            console.log('location', location)
                            self.updateLocation(val);
                        }
                    }
                }
            });
            //find which levels need to be hidden
            hidden_level = _.filter(self.data.levels , function (o){ 
                // console.log (o); 
                return o.show !== true;
            });
            //doing it in a loop for future cases where there are more than two floors
            _.forEach(hidden_level, function(val, key) {
                $(".mapplic-layer[data-floor='"+val.id+"']").hide();
            });
            
            $('.map_pin_a').click(function(e){
                e.preventDefault();
                var svgmap_region = $(this).attr('data-svg');
                dropPin(svgmap_region);
            });
            setTimeout(function() {
                console.log("lol")
                 init_side();
                show_content();
            }, 500);
        }
        loadMallDataCached(renderAll); 
        // https://www.mallmaverick.com/system/site_images/photos/000/037/939/original/St.Vital_-_Map_-_Mar-21-2018.svg?1521739249
    });
    function dropPin(param) {
        // self = map.data('mapplic');
        // self.showLocation(svgmap_region);
		store_id = $(param).attr('store_id');
		if(store_id){
            // drop_pin(store_id)
            self.showLocation(store_id);
		}
		
        $('#stores_table').hide();
    }
     $(function(){
        $("#map_button").click(function(){
            $("#store_table").toggle();
        });
        
    });
    function hide_table(){
        $("#store_table").hide();
        show_table = false;
    }
</script>
<!--<script>-->
<!--    function show_pin(param){-->
<!--		store_id = $(param).attr('store_id');-->
<!--		if(store_id){-->
<!--            drop_pin(store_id)-->
<!--		}-->
		
<!--		$('#store_table').hide()-->
<!--		return false;-->
<!--    }-->
<!--    $(function(){-->
<!--        $("#map_button").click(function(){-->
<!--            $("#store_table").toggle();-->
<!--        });-->
        
<!--    });-->
<!--    function hide_table(){-->
<!--        $("#store_table").hide();-->
<!--        show_table = false;-->
<!--    }-->
<!--    $(document).ready(function(e) {-->
<!--        init(e);-->
<!--        function renderAll(){-->
            <!--var stores = getStoresList();-->
            <!--renderStoreList('#store_list_container','#store_list_template', stores, "stores");-->
<!--            init_side();-->
<!--            show_content();  -->
<!--            regions = {}-->
<!--            $.each(stores, function(i, val){-->
<!--                if(val.svgmap_region != null && typeof(val.svgmap_region)  != 'undefined'){-->
<!--                    obj = {};-->
                     <!--obj["tooltip"] = "<label class='store_name_map store_name_map_detail'> " + val.name + " </label>",-->
<!--                    if(val.store_front_url_abs.indexOf('missing.png') > -1){-->
<!--                        obj["tooltip"] = "<div class='tooltip_div'><p class='tooltip_name text-center'>"+val.name+"</p></div>"-->
<!--                    }-->
<!--                    else{-->
<!--                        obj["tooltip"] = "<div class='tooltip_div'><img src='" + val.store_front_url_abs + "'><p class='tooltip_name text-center'>"+val.name+"</p></div>"-->
<!--                    }-->
<!--                    obj["popover"] = "<label class='store_name_map store_name_map_detail'>" + val.name + "</label>",-->
<!--                    obj["attr"] = {fill: "#000"},-->
<!--                    regions[val.svgmap_region] = obj-->
<!--                }-->
<!--            });-->
            
<!--            init_map(regions)-->
<!--        }-->
<!--        loadMallDataCached(renderAll); -->
<!--    })-->
<!--</script>-->