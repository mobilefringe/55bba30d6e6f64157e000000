<!-- Map Dependency -->
<script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.13/jquery.mousewheel.min.js"></script>
<script src="//codecloud.cdn.speedyrails.net/sites/5ae8c1fe6e6f6473fd160000/text/javascript/1520366143656/mapplic_mmsdk.js"></script>
<script src="//codecloud.cdn.speedyrails.net/sites/59bac7db6e6f644f22ba0000/text/javascript/1484859750000/hammer.min.js"></script>

<style>
    .map_container{
        height:490px;
    }
    .popup {
        background: none repeat scroll 0 0 #000000;
        border: 1px solid #808080;
        border-radius: 6px;
        box-shadow: -1px 1px 4px 1px #000;
        color: #ffffff;
        font-size: 18px;
        font-weight: bold;
        padding-bottom: 8px;
        padding-top: 8px;
        text-align: center;
        width: 200px;
        margin-top: 30px;
    }
    .store_initial {
        color: #fff;
        background: black;
        margin-bottom: 10px;
        padding: 10px 12px;
        font-weight: bold;
        opacity: 0.8;
        width:100%;
    }
    .store_name_map {
        color: #000000;
        font-size: 18px;
        font-weight: 400;
        padding: 5px 12px;
        width: 250px;
        display: block;
    }
    .position_relative .dropdown-menu{
        width:300px;
        padding-top:0;
        margin-top:2px;
    }
    .map_tooltip img{
        max-width:200px;
    }
</style>
<div class="green_bar"></div>
<div class="page_main_container">
    <div class="page_left">
        <h3 class="hours_heading promo_heading">Centre Map</h3>
        <div class="position_relative">        
            <div class="controls">
            	<div class="dropdown custom_dropdown">                          
                    <a class="btn-prime"  id="map_button">
                        Select a Store <span style="margin-top:3px;" class="fa fa-caret-down pull-right"></span>
                    </a>		    
                </div>            
            </div> 
            <div class="dropdown-menu bottom" id="store_table" style="top:50px">          		
                <div style="height:500px;overflow-y:scroll;overflow-x:hidden;">                                        
                    <div class="map_table">            			                        
                        <div  id="store_list_container">
                            <script id="store_list_template" type="x-tmpl-mustache/text">
                                <p class="store_initial" style="{{show}}">{{initial}}</p>
                                <a href="#" class="store_name_map" store_id="{{svgmap_region}}" onclick="return show_pin(this)">{{name}}</a>
                            </script>
                        </div>
                    </div>          
                </div>                
            </div> 
            <div class="map">
          <!--      <div class="map_container" style="">            -->
          <!--          <img style="max-width:100%;max-height:100%" alt="map_image" id="map_image" src="//midtown2.mallmaverick.com/system/properties/maps/000/000/025/original/map_midtown_edited.jpg?1381443167" />   -->
                    	
        		<!--</div>-->
               <div id="mapplic" class="mapplic"></div>
            </div>
        </div>
    </div>
    <div class="page_right">
        <div class="hours_box feature_box" id="home_hours_container">
            <script id="home_hours_template" type="x-tmpl-mustache/text">
                <h3 class="hours_header">HOURS</h3>
                <p class="check_hours"><a href="/hours">Check Holiday Hours</a></p>
                <h3 class="newsletter_header caps">{{day}} {{month}} {{weekday}}</h3>
                <h3 class="hours_home">{{h}}</h3>
                <p class="call_mp_home"><a href="tel:3066538844">Call 306-653-8844</a></p>
            </script>
        </div>
        <div class="giftcards_box feature_box">
            <a href="/pages/midtown2-gift-cards">
                <h3 class="giftcards_header">GIFT CARDS</h3>
                <img style=" max-width: 100%; max-height: 100%; " src="//codecloud.cdn.speedyrails.net/sites/55bba30d6e6f64157e000000/f80b2b0cc97fadff100319399f8b2e1e/midtown_gc_360_360.png" class="" alt="giftcards">
            </a>
        </div>
        
        <div class="newsletter_box feature_box">
            <div id="success_subscribe">
                <i class="fa fa-close pull-right cursor_pointer" id="close_subscribe" style="color:#fff"></i>
                <p class="middle_align text-center">Thank you for subscribing to our newsletter!</p>
            </div>
            <h3 class="newsletter_header">NEWSLETTER</h3>
            <p>Exclusive deals straight to your inbox!</p>
            <div id="newsletter_form" class="js-cm-form">	
                    <input id="newsletter_email" type="email" placeholder="Enter your email address" class="pull-left" required />
                    <button id="routing-button" onclick="pushNewsletterRoute()" class="btn_mp pull-left">SUBSCRIBE</button>
            </div>
        </div>
        <div class="feature_box border_1">
            <h3 class="feature_header">Blog</h3>
            <div class="feature_insider" id="home_blog_container">
                <script id="home_blog_template" type="x-tmpl-mustache/text">
                    <div class="feature_insider_right">
                        <h3 class="feature_2_header">{{published_on}}</h3>
                        <p class="feature_2_dates">{{title}}</p>
                        <p class="feature_2_description">{{description_shorter}}</p>
                        <a class="read_more" href="/posts/{{slug}}">read more</a>
                    </div>
                    <div class="feature_insider_left pull-right">
                        <img alt="blog" class="feature_image" src="{{post_image}}" />
                    </div>
                    <div class="clearfix"></div>
                </script>
            </div>
        </div>
    </div>
    <div class="clearfix"></div>
</div>
<script>
    function show_pin(param){
		store_id = $(param).attr('store_id');
		if(store_id){
            dropPin(store_id)
		}
		
		$('#store_table').hide()
		return false;
    }
    $(function(){
        $("#map_button").click(function(){
            $("#store_table").toggle();
        });
        
    });
    function hide_table(){
        $("#store_table").hide();
        show_table = false;
    }
    $(document).ready(function(e) {
        init(e);
        function renderAll(){
            var stores = getStoresList();
            renderStoreList('#store_list_container','#store_list_template', stores, "stores");
            init_side();
            show_content();
            var mall_json = {};
            var landmarks = {};
            mall_json.mapwidth = "1000";
            mall_json.mapheight = "1000";
            mall_json.categories = [];
            mall_json.levels = [];
            
            // need to add the following for each floor we want to configure.
            _.forEach(floorList(), function(value, key) { 
                var floor_1 = {};
                floor_1.id = value.id;
                floor_1.title = value.title;
                floor_1.map = value.map;
                floor_1.show = value.show;
                floor_1.locations = [];
                // var stores_on_floors =  _.filter(stores, function(o) {return value.z_index === o.z_coordinate;}); 
                var stores_on_floors= [];
                if( value.z_index === 0) {
                    stores_on_floors = stores;
                } else {
                    stores_on_floors = stores;
                }
                _.forEach(stores_on_floors, function(val, key) {
                    //for testing limiting the store numbers to vm
                    var temp_val = {};
                    temp_val.id = val.svgmap_region;
                    temp_val.title = val.name;
                    temp_val.about = val.description.substring(0,200);
                    if(val.categories != null) {
                        if(val.categories.length > 1){
                        temp_val.category = val.categories[1];
                        } else {
                            temp_val.category = val.categories[0];
                        }
                    }
                    temp_val.zoom = 2;
                    temp_val.link = "/stores/" + val.slug;
                    temp_val.pin = "hidden";
                   
                    //get svg's wifth/height by checking the map
                    var svg_width = 2500;
                    var svg_height = 2500;

                    if(val.x_coordinate) {
                        temp_val.x = val.x_coordinate / svg_width;
                    }
                    else {
                        temp_val.x = 0.5;
                    }
                    if(val.y_coordinate) {
                        temp_val.y = val.y_coordinate / svg_height;
                    }
                    else {
                        temp_val.y = 0.5;
                    }
                    floor_1.locations.push(temp_val);
                });
                mall_json.levels.push(floor_1);
            });
            var height_map = 650;
            if(window.innerWidth <=768){
                height_map = 350;
            }
            map = $('#mapplic').mapplic({
            	source: mall_json,
            	height: height_map,
            	landmark : true,
            	mapfill:true,
            	minimap: false,
            	sidebar: false,
            	hovertip: true,
            	developer: false,
            	fullscreen : false,
            	clearbutton: false,
            	deeplinking: false,
            	fillcolor : "none",
            	maxscale: 5,
            	skin: 'mapplic-dark',
            	tooltiplabel : 'View Store Details'
            });
            
            map.on('mapready', function(e, self) {
				// console.log('Map is ready!');
				mapLoaded(map);
				$('.map_pin_a').click(function(e){
                    e.preventDefault();
                    var svgmap_region = $(this).attr('data-svg');
                    dropPin(svgmap_region);
                });
                
                $("#store_mobile_conatiner").bind("change", function(e) {
                    e.preventDefault()
                    var selectedOption = $("#store_mobile_conatiner option:selected")
                    selectedOption = selectedOption[0]
                    var svgmap_region = $(selectedOption).attr('data-svg');
                    dropPin(svgmap_region);
                });
            
                show_content();
			});
            // regions = {}
            // $.each(stores, function(i, val){
            //     if(val.svgmap_region){
            //         obj = {};
            //         // obj["tooltip"] = "<label class='store_name_map store_name_map_detail'> " + val.name + " </label>",
            //         if(val.store_front_url_abs.indexOf('missing.png') > -1){
            //             obj["tooltip"] = "<div class='tooltip_div'><p class='tooltip_name text-center'>"+val.name+"</p></div>"
            //         }
            //         else{
            //             obj["tooltip"] = "<div class='tooltip_div'><img src='" + val.store_front_url_abs + "'><p class='tooltip_name text-center'>"+val.name+"</p></div>"
            //         }
            //         obj["popover"] = "<label class='store_name_map store_name_map_detail'>" + val.name + "</label>",
            //         obj["attr"] = {fill: "#000"},
            //         regions[val.svgmap_region] = obj
            //     }
            // });
            
            // init_map(regions)
        }
        function mapLoaded (map) {
            self = map.data('mapplic');
            var svg = document.getElementById('landmarks-1');
            
            // get all floors to be visible 
            $(".mapplic-layer").show();
            // go through all the regions and recalculate the locations
            _.forEach(svgList(), function(val, key) {
                if(val != null) {
                    try {
                        var element = document.getElementById(val);
                        if (element){
                            elBBox = element.getBoundingClientRect();
                            var viewport_center_x = 0;
                            var viewport_center_y = 0;
                            viewport_center_x = (_.toNumber(elBBox.left) + _.toNumber(elBBox.right) )/2;
                            viewport_center_y = (_.toNumber(elBBox.top) + _.toNumber(elBBox.bottom) )/2;
                            pt = svg.createSVGPoint();
                            pt.x = viewport_center_x;
                            pt.y = viewport_center_y;
                            var svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
                            var new_x = svgP.x/ 2500;
                            var new_y = svgP.y/ 2500;
                            var location = self.getLocationData(val);
                            if(location !== null && location.el){
                                location.x = new_x;
                                location.y =  new_y;
                                self.updateLocation(val);
                            }
                        }
                    } catch(error) {
                        console.error(error);
                        
                    }
                }
            });
            
            //find which levels need to be hidden
            hidden_level = _.filter(self.data.levels , function (o){ 
                return o.show !== true;
            });
            
            //doing it in a loop for future cases where there are more than two floors
            _.forEach(hidden_level, function(val, key) {
                $(".mapplic-layer[data-floor='"+val.id+"']").hide();
            });
        }
        
        loadMallDataCached(renderAll); 
        
        function pushNewsletterRoute(){
            let btn = document.querySelector("#routing-button");
            let emailEntered = ($('#newsletter_email')[0].value)
            window.document.location = '/newsletter' + '?email=' + emailEntered;
        }
          
    })
</script>