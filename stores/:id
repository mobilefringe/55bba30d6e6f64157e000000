<!-- Map Dependency -->
<script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.13/jquery.mousewheel.min.js"></script>
<script src="//codecloud.cdn.speedyrails.net/sites/5ae8c1fe6e6f6473fd160000/text/javascript/1520366143656/mapplic_mmsdk.js"></script>
<script src="//codecloud.cdn.speedyrails.net/sites/59bac7db6e6f644f22ba0000/text/javascript/1484859750000/hammer.min.js"></script>

<div class="green_bar"></div>
<div class="page_main_container">
    <div class="page_left">
        <div id="store_container">
            <script id="store_template" type="x-tmpl-mustache">
                <div class="map-container">
                   
                    <div id="mapsvg_store_detail" class="mapplic"></div>
                </div>
                <div class="store_details_container">
                    <div class="row middle_align">
                        <div class="left_promo_div">
                            <img src="{{alt_store_front_url}}" alt="Store Logo" /> 
                        </div>
                        <div class="col-md-5 store_middle">
                            <p class="middle_align store_name">{{name}}</p>
                        </div>
                        <div class="col-md-4 store_middle">
                            <div class="middle_align">
                                <p class="store_website">
                                    <span style="{{show}}"><a target="_blank" href="//{{website}}">website</a> &nbsp; | &nbsp;</span>
                                    <span>{{phone}}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        {{#unit}}<p>Unit: {{unit}}</p>{{/unit}}
                        {{#z_coordinate}}<p>Floor: {{z_coordinate}}</p>{{/z_coordinate}}
                        <div class="store_details_description {{desc_pad}}">{{description}}</div>
                    </div>
                </div>
            </script>
        </div>
        <h2 class="store_list_heading2" id="no_promos">PROMOTIONS & EVENTS</h2>
        <div id="promotions_container">
            <script id="promotions_template" type="x-tmpl-mustache">
                <div class="row">
                   <div class="left_promo_div">
                        <img class="img_auto" src="{{promo_image_url_abs}}" alt="promo" /> 
                    </div>
                    <div class="col-md-9">
                        <p class="promo_name"><a href="/promotions/{{slug}}">{{name}}</a></p>
                        <p class="promo_date">{{dates}}</p>
                        <p class="promo_desc">{{description}}</p>
                        <a href="/promotions/{{slug}}" class="read_more">read more</a>
                    </div>
                </div>
                <hr class="promo_separator" />
            </script>
        </div>
        <h2 class="store_list_heading2" id="no_jobs">CAREERS</h2>
        <div id="jobs_container">
            <script id="jobs_template" type="x-tmpl-mustache">
                <div class="row">
                    <div class="col-md-12">
                        <p class="promo_name"><a href="/promotions/{{slug}}">{{name}}</a></p>
                        <p class="closing_date">Closing date: {{closing_date}}</p>
                        <a data-toggle="collapse" data-parent="#jobs_container" href="#{{slug}}" class="read_more">read more</a>
                        <div id="{{slug}}" class="panel-collapse collapse job_div">
                            <p>{{job_type}}</p>
                            <div>{{{rich_description}}}</div>
                            <br />
                            <div style="{{hide_contact}}">
                                <p class="promo_date">Contact</p>
                                <p>{{contact_name}}</p>
                                <p>{{contact_email}}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <hr class="promo_separator" />
            </script>
        </div>
        <a href="/stores" class="back_btn"><i class="fa fa-chevron-left"></i> &nbsp;BACK</a>
        <br /><br />
    </div>
    <div class="page_right">
        <div class="hours_box feature_box" id="home_hours_container">
            <script id="home_hours_template" type="x-tmpl-mustache/text">
                <h3 class="hours_header">HOURS</h3>
                <p class="check_hours"><a href="/hours">Check Holiday Hours</a></p>
                <h3 class="newsletter_header caps">{{day}} {{month}} {{weekday}}</h3>
                <h3 class="hours_home">{{h}}</h3>
                <p class="call_mp_home"><a href="tel:3066538844">Call 306-653-8844</a></p>
            </script>
        </div>
        <div class="giftcards_box feature_box">
            <a href="/pages/midtown2-gift-cards">
                <h3 class="giftcards_header">GIFT CARDS</h3>
                <img src="//codecloud.cdn.speedyrails.net/sites/599dcb2e6e6f6420d91e0300/image/png/1511216744000/New Gift Card.png" class="" alt="giftcards">
            </a>
        </div>
        
        <div class="newsletter_box feature_box">
            <div id="success_subscribe">
                <i class="fa fa-close pull-right cursor_pointer" id="close_subscribe" style="color:#fff"></i>
                <p class="middle_align text-center">Thank you for subscribing to our newsletter!</p>
            </div>
            <h3 class="newsletter_header">NEWSLETTER</h3>
            <p>Exclusive deals straight to your inbox!</p>
            <div id="newsletter_form" class="js-cm-form">	
                    <input id="newsletter_email" type="email" placeholder="Enter your email address" class="pull-left" required />
                    <button id="routing-button" class="btn_mp pull-left">SUBSCRIBE</button>
            </div>
        </div>
        <div class="feature_box border_1">
            <h3 class="feature_header">Blog</h3>
            <div class="feature_insider" id="home_blog_container">
                <script id="home_blog_template" type="x-tmpl-mustache/text">
                    <div class="feature_insider_right">
                        <h3 class="feature_2_header">{{published_on}}</h3>
                        <p class="feature_2_dates">{{title}}</p>
                        <p class="feature_2_description">{{description_shorter}}</p>
                        <a class="read_more" href="/posts/{{slug}}">read more</a>
                    </div>
                    <div class="feature_insider_left pull-right">
                        <img alt="blog" class="feature_image" src="{{post_image}}" />
                    </div>
                    <div class="clearfix"></div>
                </script>
            </div>
        </div>
    </div>
    <div class="clearfix"></div>
</div>
<script>
    $(document).ready(function(e){
        init(e);
        function renderAll(){
            var pathArray = window.location.pathname.split( '/' );
            var slug = pathArray[pathArray.length-1];
            var store_details = getStoreDetailsBySlug(slug);
            renderStoreDetails("#store_container","#store_template", store_details, slug);
            
            if (store_details.promotions != null) {
                renderStoreExtras($('#promotions_container'), $('#promotions_template'), "promos", store_details.promotions);
            } else {
                $('#no_promos').hide();
            }
            
            if (store_details.jobs != null) {
                renderStoreExtras($('#jobs_container'), $('#jobs_template'), "jobs", store_details.jobs);
            } else {
                $('#no_jobs').hide();
            }
            
            init_side();
            show_content();

            /* MAP */
            var stores = getStoresList();
            var mall_json = {};
            var landmarks = {};
            mall_json.mapwidth = "1000";
            mall_json.mapheight = "1000";
            mall_json.categories = [];
            mall_json.levels = [];
    
            // need to add the following for each floor we want to configure.
            _.forEach(floorList(), function(value, key) {
                var floor_1 = {};
                floor_1.id = value.id;
                floor_1.title = value.title;
                floor_1.map = value.map;
                floor_1.show = value.show;
                floor_1.locations = [];
                var stores_on_floors= [];
                // if( value.z_index === 0) {
                    stores_on_floors = stores;
                // } else {
                //     stores_on_floors = _.filter(stores, function(o) { if(o.z_coordinate == null) {return true;} else { return value.z_index === o.z_coordinate; }});
                // }
                _.forEach(stores_on_floors, function(val, key) {
                    //for testing limiting the store numbers to vm
                    var temp_val = {};
                    temp_val.id = val.svgmap_region;
                    temp_val.title = val.name;
                    temp_val.about = val.description.substring(0, 200);
                    if (val.categories != null) {
                        if (val.categories.length > 1) {
                            temp_val.category = val.categories[1];
                        } else {
                            temp_val.category = val.categories[0];
                        }
                    }
                    temp_val.zoom = 2;
                    temp_val.link = "/stores/" + val.slug;
                    temp_val.pin = "hidden";

                    //get svg's width/height by checking the map
                    var svg_width = 2500;
                    var svg_height = 2500;
                    temp_val.x = val.x_coordinate / svg_width;
                    temp_val.y = val.y_coordinate / svg_height;
                    
                    // temp_val.zoom = "5";
                    floor_1.locations.push(temp_val);
                });
                mall_json.levels.push(floor_1);
            });
    
            map = $('#mapsvg_store_detail').mapplic({
                source: mall_json,
                height: 400,
                landmark: true,
                mapfill: true,
                minimap: false,
                sidebar: false,
                hovertip: true,
                developer: false,
                fullscreen: false,
                clearbutton: false,
                deeplinking: false,
                fillcolor: "none",
                maxscale: 1,
                skin: 'mapplic-dark',
                action: "tooltip"
            });

            map.on('mapready', function(e, self) {
                mapLoaded(map);
                self.showLocation(store_details.svgmap_region);
            });
        }
        
        function mapLoaded(map) {
            var pathArray = window.location.pathname.split('/');
            var slug = pathArray[pathArray.length - 1];
            var store_details = getStoreDetailsBySlug(slug);
            self = map.data('mapplic');
            var svg = document.getElementById('landmarks-1');
    
            //get floors to be visible 
            $(".mapplic-layer").show();
            //go through all the regions and recalculat the locations
            _.forEach(svgList(), function(val, key) {
                if (val !== null) {
                    try {
                        var element = document.getElementById(val);
                        if (element) {
                            elBBox = element.getBoundingClientRect();
                            var viewport_center_x = 0;
                            var viewport_center_y = 0;
                            viewport_center_x = (_.toNumber(elBBox.left) + _.toNumber(elBBox.right)) / 2;
                            viewport_center_y = (_.toNumber(elBBox.top) + _.toNumber(elBBox.bottom)) / 2;
                            pt = svg.createSVGPoint();
                            pt.x = viewport_center_x;
                            pt.y = viewport_center_y;
                            var svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
                            var new_x = svgP.x / 2500;
                            var new_y = svgP.y / 2500;
                            
                            var location = self.getLocationData(val);
                            if (location !== null && location.el) {
                                location.x = new_x;
                                location.y = new_y;
                                
                                if (store_details.svgmap_region == val) {
                                    location.pin = "black-pin";
                                }
                                self.updateLocation(val);
    
                                if (store_details.svgmap_region == val) {
                                    self.showLocation(val);
                                    self.addPin(val);
                                }
                            }
                        }
                    } catch(error) {
                        console.error(error);
                    }
                }
            });

            //find which levels need to be hidden
            hidden_level = _.filter(self.data.levels, function(o) {
                return o.show !== true;
            });
            
            //doing it in a loop for future cases where there are more than two floors
            _.forEach(hidden_level, function(val, key) {
                $(".mapplic-layer[data-floor='" + val.id + "']").hide();
            });
        }
        $( "#routing-button" ).on( "click", function() {
            let emailEntered = ($('#newsletter_email')[0].value)
            window.document.location = '/newsletter' + '?email=' + emailEntered;
        });
        loadMallDataCached(renderAll); 
    })
</script>
<style>
    .mapplic-popup-link,.mapplic-tooltip-close{
        display:none!important;
    }
</style>